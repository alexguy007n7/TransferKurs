<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üìÅ GoFile ¬∑ Direct DL + QR</title>
    <!-- html5-qrcode untuk scan QR -->
    <script src="https://unpkg.com/html5-qrcode" minified></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body {
            background: linear-gradient(145deg, #f6f9fc 0%, #edf1f7 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
        }
        .container {
            max-width: 1100px;
            width: 100%;
            background: rgba(255,255,255,0.75);
            backdrop-filter: blur(12px);
            border-radius: 32px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.5);
        }
        h1 { font-size: 28px; font-weight: 700; color: #0b2b4a; margin-bottom: 8px; }
        .sub {
            color: #3e5e7e; margin-bottom: 24px; font-size: 15px;
            border-left: 5px solid #2e7eb0; padding-left: 16px;
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap;
        }
        .btn-scan {
            background: #0b2b4a; color: white; border: none; padding: 10px 20px;
            border-radius: 50px; font-weight: 600; display: flex; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .upload-card {
            background: white; border-radius: 24px; padding: 24px;
            border: 1px solid rgba(0,0,0,0.04); margin-bottom: 24px;
        }
        .area-upload {
            display: flex; flex-wrap: wrap; align-items: center; gap: 16px;
        }
        .btn {
            background: white; border: 1.5px solid #d4e0e9; padding: 12px 24px;
            border-radius: 50px; font-weight: 600; font-size: 15px; color: #1e3a5f;
            display: inline-flex; align-items: center; gap: 8px; cursor: pointer;
        }
        .btn-primary {
            background: #0b2b4a; border: none; color: white;
            box-shadow: 0 8px 18px rgba(11,43,74,0.2);
        }
        .file-list {
            background: white; border-radius: 24px; padding: 20px;
            border: 1px solid rgba(0,0,0,0.04);
        }
        .file-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
        }
        .file-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: #fafdff; border-radius: 20px; margin-bottom: 12px;
            border-left: 6px solid #2e7eb0; flex-wrap: wrap; gap: 12px;
        }
        .file-info { flex: 2; min-width: 200px; }
        .file-name { font-weight: 700; color: #0a1c2e; word-break: break-word; }
        .file-meta { display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px; }
        .badge-size {
            background: #e6edf4; padding: 4px 14px; border-radius: 40px;
        }
        .btn-sm {
            padding: 8px 16px; font-size: 13px; border-radius: 40px;
            border: 1px solid #cbd6e0; background: white; font-weight: 600; cursor: pointer;
        }
        .btn-delete { color: #b33a3a; border-color: #f3cdcd; }
        .progress-bar {
            width: 100%; height: 6px; background: #e2e8f0; border-radius: 10px; margin-top: 12px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: #2e7eb0; width: 0%; transition: width 0.2s;
        }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            align-items: center; justify-content: center; z-index: 9999;
        }
        .modal-content {
            background: white; padding: 28px; border-radius: 32px; max-width: 400px; width: 90%;
            text-align: center;
        }
        .qr-image { width: 200px; height: 200px; margin: 20px auto; border: 2px solid #e2e8f0; padding: 10px; border-radius: 20px; background: white; }
        .qr-image img { width: 100%; height: 100%; object-fit: contain; }
        #qr-scanner-container {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #reader { width: 100%; max-width: 450px; background: black; border-radius: 24px; overflow: hidden; }
        .close-scanner {
            margin-top: 20px; background: white; border: none; padding: 12px 30px;
            border-radius: 50px; font-weight: 600; cursor: pointer;
        }
        .expiry-selector {
            display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
            margin-top: 16px;
        }
        .footer { margin-top: 32px; text-align: center; color: #4e6a7c; font-size: 13px; }
        .note {
            font-size: 13px; color: #5e6f7e; background: #f1f5f9; padding: 8px 16px; border-radius: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÅ GoFile ¬∑ Upload & QR</h1>
        <div class="sub">
            <span>‚ö° Upload ke GoFile.io (gratis, max 4GB). Link langsung & QR.</span>
            <button id="scanQrBtn" class="btn-scan">üì∑ Scan QR</button>
        </div>

        <!-- UPLOAD CARD -->
        <div class="upload-card">
            <div class="area-upload">
                <label for="fileInput" class="btn btn-primary">
                    üìÅ Pilih File (max 4GB)
                </label>
                <input type="file" id="fileInput" hidden>
                <span class="note">File dikirim ke server GoFile</span>
            </div>
            
            <!-- Progress bar (muncul saat upload) -->
            <div id="uploadProgress" style="display: none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span id="uploadStatus">‚è≥ Mengupload...</span>
                    <span id="uploadPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="uploadProgressFill" class="progress-fill" style="width:0%"></div>
                </div>
            </div>

            <!-- Expired selector -->
            <div class="expiry-selector">
                <label style="font-weight:600;">‚è±Ô∏è Hapus dari daftar setelah:</label>
                <select id="expirySelect">
                    <option value="5">5 menit</option>
                    <option value="30">30 menit</option>
                    <option value="60">1 jam</option>
                    <option value="360">6 jam</option>
                    <option value="1440">1 hari</option>
                    <option value="10080">7 hari</option>
                    <option value="0">Jangan hapus</option>
                </select>
            </div>

            <div id="uploadMessage" style="margin-top: 16px; color: #2e7eb0;"></div>
        </div>

        <!-- DAFTAR FILE -->
        <div class="file-list">
            <div class="file-header">
                <h3>üìã File terupload</h3>
                <span id="fileCount" style="background:#e9f2f9; padding:6px 16px; border-radius:30px;">0 file</span>
            </div>
            <div id="fileListContainer">
                <div class="empty-message" style="text-align:center; padding:40px; color:#657e94;">
                    ‚ö° Belum ada file. Pilih file untuk upload.
                </div>
            </div>
        </div>
        <div class="footer">‚ö° OXYX ¬∑ GOFILE.IO ¬∑ QR ¬∑ DIRECT DOWNLOAD</div>
    </div>

    <!-- MODAL QR -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <h3>üîó QR Code Download</h3>
            <div id="qrImageContainer" class="qr-image"></div>
            <p id="qrFileName" style="font-weight:600;"></p>
            <button id="closeQrModal" class="close-scanner" style="margin-top:12px;">Tutup</button>
        </div>
    </div>

    <!-- SCANNER QR -->
    <div id="qr-scanner-container">
        <div id="reader"></div>
        <button id="closeScanner" class="close-scanner">Tutup Scanner</button>
    </div>

    <script>
        (function() {
            "use strict";

            // ========== GLOBAL ==========
            // Endpoint upload GoFile.io
            const GOFILE_UPLOAD_URL = 'https://store1.gofile.io/uploadFile';

            // Storage key untuk localStorage
            const STORAGE_KEY = 'GoFileUploads';

            // Daftar file (metadata)
            let fileItems = [];

            // Elemen DOM
            const fileInput = document.getElementById('fileInput');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadPercent = document.getElementById('uploadPercent');
            const uploadProgressFill = document.getElementById('uploadProgressFill');
            const uploadMessage = document.getElementById('uploadMessage');
            const fileListContainer = document.getElementById('fileListContainer');
            const fileCountSpan = document.getElementById('fileCount');
            const expirySelect = document.getElementById('expirySelect');

            // QR elements
            const qrModal = document.getElementById('qrModal');
            const qrImageContainer = document.getElementById('qrImageContainer');
            const qrFileName = document.getElementById('qrFileName');
            const closeQrModal = document.getElementById('closeQrModal');

            // Scanner
            const scanQrBtn = document.getElementById('scanQrBtn');
            const scannerContainer = document.getElementById('qr-scanner-container');
            const closeScanner = document.getElementById('closeScanner');
            let html5QrCode = null;

            // ========== LOAD / SAVE ==========
            function loadFileList() {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    try {
                        fileItems = JSON.parse(stored);
                    } catch(e) {
                        fileItems = [];
                    }
                } else {
                    fileItems = [];
                }
                // Filter expired
                const now = Date.now();
                fileItems = fileItems.filter(f => !f.expiresAt || f.expiresAt > now);
                saveFileList();
                renderFileList();
            }

            function saveFileList() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(fileItems));
            }

            // ========== FORMAT BYTES ==========
            function formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(1024));
                return parseFloat((bytes / Math.pow(1024, i)).toFixed(1)) + ' ' + sizes[i];
            }

            // ========== UPLOAD KE GOFILE.IO ==========
            async function uploadFile(file) {
                const formData = new FormData();
                formData.append('file', file);

                const xhr = new XMLHttpRequest();
                xhr.open('POST', GOFILE_UPLOAD_URL, true);

                // Progress
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        uploadPercent.textContent = `${percent}%`;
                        uploadProgressFill.style.width = `${percent}%`;
                        uploadStatus.textContent = `‚è≥ Upload ${e.loaded}/${e.total} bytes`;
                    }
                };

                return new Promise((resolve, reject) => {
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                const resp = JSON.parse(xhr.responseText);
                                if (resp.status === 'ok') {
                                    // GoFile response: { status: "ok", data: { code, fileName, size, downloadPage, ... } }
                                    const data = resp.data;
                                    resolve(data);
                                } else {
                                    reject(new Error(resp.message || 'Upload gagal'));
                                }
                            } catch(e) {
                                reject(e);
                            }
                        } else {
                            reject(new Error(`HTTP ${xhr.status}`));
                        }
                    };
                    xhr.onerror = () => reject(new Error('Network error'));
                    xhr.send(formData);
                });
            }

            // ========== GENERATE DIRECT DOWNLOAD LINK ==========
            function getDirectLink(code, fileName) {
                // Format direct download GoFile
                return `https://gofile.io/download/${code}/${encodeURIComponent(fileName)}`;
            }

            // ========== TAMBAH FILE KE DAFTAR ==========
            async function handleFileUpload(file) {
                if (!file) return;

                uploadProgress.style.display = 'block';
                uploadPercent.textContent = '0%';
                uploadProgressFill.style.width = '0%';
                uploadMessage.textContent = '';

                try {
                    const result = await uploadFile(file);
                    // result.code, result.fileName, result.size, result.downloadPage
                    const code = result.code;
                    const fileName = result.fileName || file.name;
                    const fileSize = result.size || file.size;

                    // Hitung expired jika dipilih
                    let expiresAt = null;
                    const expiryMinutes = parseInt(expirySelect.value);
                    if (expiryMinutes > 0) {
                        expiresAt = Date.now() + (expiryMinutes * 60 * 1000);
                    }

                    const directLink = getDirectLink(code, fileName);
                    const downloadPage = result.downloadPage; // untuk referensi

                    const newFile = {
                        id: code,  // gunakan code sebagai ID unik
                        name: fileName,
                        size: fileSize,
                        code: code,
                        directLink: directLink,
                        downloadPage: downloadPage,
                        addedAt: Date.now(),
                        expiresAt: expiresAt
                    };

                    fileItems.unshift(newFile);
                    saveFileList();
                    renderFileList();

                    uploadMessage.textContent = `‚úÖ ${fileName} berhasil diupload!`;
                } catch (err) {
                    console.error(err);
                    uploadMessage.textContent = `‚ùå Gagal upload: ${err.message}`;
                } finally {
                    uploadProgress.style.display = 'none';
                    fileInput.value = ''; // reset input
                }
            }

            // ========== RENDER DAFTAR FILE ==========
            function renderFileList() {
                // Filter expired
                const now = Date.now();
                fileItems = fileItems.filter(f => !f.expiresAt || f.expiresAt > now);
                saveFileList();

                fileCountSpan.textContent = `${fileItems.length} file`;

                if (fileItems.length === 0) {
                    fileListContainer.innerHTML = `<div class="empty-message">üì≠ Belum ada file. Upload sekarang!</div>`;
                    return;
                }

                let html = '';
                fileItems.forEach((file, index) => {
                    let expiryText = '';
                    if (file.expiresAt) {
                        const remaining = file.expiresAt - now;
                        if (remaining > 0) {
                            const minutes = Math.floor(remaining / 60000);
                            const seconds = Math.floor((remaining % 60000) / 1000);
                            expiryText = `‚è≥ ${minutes}m ${seconds}s`;
                        } else {
                            expiryText = `‚èπÔ∏è Expired`;
                        }
                    } else {
                        expiryText = `‚àû Permanen`;
                    }

                    html += `
                        <div class="file-item" data-file-id="${escapeHtml(file.id)}">
                            <div class="file-info">
                                <div class="file-name">üìÑ ${escapeHtml(file.name)}</div>
                                <div class="file-meta">
                                    <span class="badge-size">${formatBytes(file.size)}</span>
                                    <span class="badge-size" style="background:#ffeed9;">${expiryText}</span>
                                </div>
                            </div>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn-sm" onclick="window.copyLink('${escapeHtml(file.directLink)}')">üîó Copy Link</button>
                                <button class="btn-sm" onclick="window.showQR('${escapeHtml(file.directLink)}', '${escapeHtml(file.name)}')">üì∑ QR</button>
                                <button class="btn-sm btn-delete" onclick="window.deleteFile('${escapeHtml(file.id)}')">‚úï Hapus</button>
                            </div>
                        </div>
                    `;
                });
                fileListContainer.innerHTML = html;
            }

            // Escape HTML
            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // ========== GLOBAL FUNCTIONS (dipanggil dari HTML) ==========
            window.copyLink = function(link) {
                navigator.clipboard.writeText(link).then(() => {
                    uploadMessage.textContent = '‚úÖ Link disalin!';
                    setTimeout(() => { uploadMessage.textContent = ''; }, 2000);
                }).catch(() => {
                    prompt('Salin manual:', link);
                });
            };

            window.deleteFile = function(fileId) {
                fileItems = fileItems.filter(f => f.id !== fileId);
                saveFileList();
                renderFileList();
                uploadMessage.textContent = 'üóëÔ∏è File dihapus dari daftar';
                setTimeout(() => { uploadMessage.textContent = ''; }, 2000);
            };

            window.showQR = function(link, fileName) {
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(link)}`;
                qrImageContainer.innerHTML = `<img src="${qrUrl}" alt="QR Code">`;
                qrFileName.textContent = `üìÑ ${fileName}`;
                qrModal.style.display = 'flex';
            };

            // ========== EVENT LISTENERS ==========
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            // Drag & drop sederhana
            document.body.addEventListener('dragover', (e) => e.preventDefault());
            document.body.addEventListener('drop', async (e) => {
                e.preventDefault();
                if (e.dataTransfer.files.length > 0) {
                    // Bisa handle multiple files, tapi kita ambil satu dulu untuk simpel
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });

            // QR Modal close
            closeQrModal.addEventListener('click', () => qrModal.style.display = 'none');
            window.addEventListener('click', (e) => {
                if (e.target === qrModal) qrModal.style.display = 'none';
                if (e.target === scannerContainer) {
                    if (html5QrCode) html5QrCode.stop();
                    scannerContainer.style.display = 'none';
                }
            });

            // ========== SCAN QR ==========
            function startScanner() {
                scannerContainer.style.display = 'flex';
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText) => {
                        html5QrCode.stop().then(() => {
                            scannerContainer.style.display = 'none';
                            // Buka link di tab baru
                            window.open(decodedText, '_blank');
                        });
                    },
                    (err) => {}
                ).catch(err => {
                    alert('Gagal akses kamera: ' + err);
                    scannerContainer.style.display = 'none';
                });
            }

            scanQrBtn.addEventListener('click', startScanner);
            closeScanner.addEventListener('click', () => {
                if (html5QrCode) html5QrCode.stop();
                scannerContainer.style.display = 'none';
            });

            // ========== INIT ==========
            window.onload = function() {
                loadFileList();

                // Refresh countdown tiap detik
                setInterval(() => {
                    const now = Date.now();
                    let changed = false;
                    fileItems.forEach(f => {
                        if (f.expiresAt && f.expiresAt <= now) changed = true;
                    });
                    if (changed) {
                        fileItems = fileItems.filter(f => !f.expiresAt || f.expiresAt > now);
                        saveFileList();
                        renderFileList();
                    } else {
                        // update teks countdown tanpa render ulang penuh? kita render ulang ringan
                        renderFileList();
                    }
                }, 1000);
            };
        })();
    </script>
</body>
</html>
