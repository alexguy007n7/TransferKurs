<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÅ Share + QR ¬∑ Expired</title>
    <!-- html5-qrcode untuk scan QR -->
    <script src="https://unpkg.com/html5-qrcode" minified></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #f6f9fc 0%, #edf1f7 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255,255,255,0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 40px;
            box-shadow: 0 20px 40px -10px rgba(0,20,40,0.15);
            padding: 32px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
            color: #0b2b4a;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .sub {
            color: #3e5e7e;
            margin-bottom: 32px;
            font-size: 16px;
            border-left: 5px solid #2e7eb0;
            padding-left: 18px;
            background: rgba(46,126,176,0.04);
            border-radius: 0 16px 16px 0;
            line-height: 1.5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-scan {
            background: #0b2b4a;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-scan:hover {
            background: #164566;
            transform: scale(1.02);
        }

        .upload-card {
            background: white;
            border-radius: 28px;
            padding: 28px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.04);
            margin-bottom: 32px;
        }

        .area-upload {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
        }

        .btn {
            background: white;
            border: 1.5px solid #d4e0e9;
            padding: 14px 28px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 16px;
            color: #1e3a5f;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-primary {
            background: #0b2b4a;
            border: none;
            color: white;
            box-shadow: 0 8px 18px rgba(11,43,74,0.2);
        }

        .btn-primary:hover {
            background: #164566;
            transform: translateY(-2px);
        }

        .btn:hover {
            background: #f4faff;
            border-color: #7aa3c2;
        }

        .expiry-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .expiry-selector label {
            font-weight: 600;
            color: #1e3a5f;
            font-size: 15px;
        }

        select, input[type="number"] {
            padding: 12px 20px;
            border-radius: 40px;
            border: 1.5px solid #d4e0e9;
            background: white;
            font-size: 15px;
            color: #0b2b4a;
            font-weight: 500;
            outline: none;
            transition: 0.2s;
        }

        select:focus, input:focus {
            border-color: #0b2b4a;
        }

        .file-list {
            background: white;
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .file-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: #0b2b4a;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            background: #fafdff;
            border-radius: 20px;
            margin-bottom: 12px;
            border-left: 6px solid #2e7eb0;
            transition: 0.15s;
            flex-wrap: wrap;
            gap: 12px;
        }

        .file-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 2;
            min-width: 200px;
        }

        .file-name {
            font-weight: 700;
            color: #0a1c2e;
            font-size: 17px;
            word-break: break-word;
        }

        .file-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            font-size: 13px;
            color: #4a667b;
        }

        .file-meta span {
            background: #e6edf4;
            padding: 4px 12px;
            border-radius: 30px;
        }

        .countdown {
            font-weight: 700;
            color: #b4511b;
            background: #ffeed9;
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .expired {
            color: #a03a2b;
            background: #ffeae5;
        }

        .btn-sm {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 40px;
            border: 1px solid #cbd6e0;
            background: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-sm:hover {
            background: #e4edf5;
        }

        .btn-delete {
            color: #b33a3a;
            border-color: #f3cdcd;
        }

        .btn-delete:hover {
            background: #ffd9d9;
        }

        .empty-message {
            text-align: center;
            padding: 50px 20px;
            color: #657e94;
            font-size: 16px;
        }

        /* MODAL QR */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 32px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #0b2b4a;
        }

        .qr-image {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border: 2px solid #e2e8f0;
            padding: 10px;
            border-radius: 20px;
            background: white;
        }

        .qr-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .close-btn {
            background: #e2e8f0;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            margin-top: 20px;
            cursor: pointer;
        }

        /* SCANNER CONTAINER */
        #qr-scanner-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #reader {
            width: 100%;
            max-width: 500px;
            background: black;
            border-radius: 24px;
            overflow: hidden;
        }

        .close-scanner {
            margin-top: 20px;
            background: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
        }

        .footer {
            margin-top: 40px;
            text-align: center;
            color: #4e6a7c;
            font-size: 14px;
            border-top: 1px solid rgba(0,0,0,0.05);
            padding-top: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚è≥ Share & Expire ¬∑ QR</h1>
        <div class="sub">
            <span>üîí File hanya disimpan di browser ini. Link berlaku di perangkat yang sama.<br>‚è∞ File otomatis dihapus setelah expired.</span>
            <button id="scanQrBtn" class="btn-scan">
                üì∑ Scan QR
            </button>
        </div>

        <!-- UPLOAD CARD -->
        <div class="upload-card">
            <div class="area-upload">
                <label for="fileInput" class="btn btn-primary">
                    üìÅ Pilih File
                </label>
                <input type="file" id="fileInput" multiple hidden>

                <div class="expiry-selector">
                    <label>‚è±Ô∏è Expired setelah:</label>
                    <select id="expirySelect">
                        <option value="5">5 menit</option>
                        <option value="30">30 menit</option>
                        <option value="60">1 jam</option>
                        <option value="360">6 jam</option>
                        <option value="1440">1 hari</option>
                        <option value="10080">7 hari</option>
                        <option value="0">Custom (detik)</option>
                    </select>
                    <input type="number" id="customExpiry" placeholder="detik" min="1" style="width:100px; padding:12px; border-radius:40px; border:1.5px solid #d4e0e9; display:none;">
                </div>
            </div>
            <div style="margin-top: 20px; color: #2e7eb0; font-weight: 500;" id="uploadStatus"></div>
        </div>

        <!-- DAFTAR FILE -->
        <div class="file-list">
            <div class="file-header">
                <h3>üìã File tersimpan</h3>
                <span id="totalSize" style="background: #e9f2f9; padding: 6px 16px; border-radius: 30px; font-size: 14px;">0 B</span>
            </div>
            <div id="fileListContainer">
                <div class="empty-message">
                    ‚ö° Belum ada file. Upload sekarang!
                </div>
            </div>
        </div>

        <div class="footer">
            ‚ö° OXYX ¬∑ PROTOKOL X ¬∑ QR GENERATE & SCAN ¬∑ EXPIRED OTOMATIS
        </div>
    </div>

    <!-- MODAL QR CODE -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <h3>üîó QR Code Link</h3>
            <div id="qrImageContainer" class="qr-image">
                <!-- QR akan diisi -->
            </div>
            <p id="qrFileName" style="font-weight:600; margin-bottom:8px;"></p>
            <button id="closeQrModal" class="close-btn">Tutup</button>
        </div>
    </div>

    <!-- SCANNER QR -->
    <div id="qr-scanner-container">
        <div id="reader"></div>
        <button id="closeScanner" class="close-scanner">Tutup Scanner</button>
    </div>

    <script>
        (function() {
            "use strict";

            // ========== INDEXEDDB ==========
            const DB_NAME = 'ExpireFileShare';
            const DB_VERSION = 1;
            const STORE_NAME = 'files';

            let db = null;

            function openDB() {
                return new Promise((resolve, reject) => {
                    if (db) return resolve(db);
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        db = request.result;
                        resolve(db);
                    };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                            store.createIndex('expiresAt', 'expiresAt', { unique: false });
                        }
                    };
                });
            }

            async function saveFile(file, expiresInSeconds) {
                await openDB();
                return new Promise((resolve, reject) => {
                    const id = Date.now() + '-' + Math.random().toString(36).substring(2) + '-' + file.name;
                    const expiresAt = Date.now() + (expiresInSeconds * 1000);
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const fileData = {
                        id: id,
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        lastModified: file.lastModified,
                        blob: file,
                        expiresAt: expiresAt,
                        uploadedAt: Date.now()
                    };
                    const request = store.put(fileData);
                    request.onsuccess = () => resolve(id);
                    request.onerror = () => reject(request.error);
                });
            }

            async function getFile(id) {
                await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result || null);
                    request.onerror = () => reject(request.error);
                });
            }

            async function deleteFile(id) {
                await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async function getAllFiles() {
                await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            }

            // ========== GLOBAL ==========
            let refreshInterval = null;
            const fileListContainer = document.getElementById('fileListContainer');
            const totalSizeSpan = document.getElementById('totalSize');
            const fileInput = document.getElementById('fileInput');
            const expirySelect = document.getElementById('expirySelect');
            const customExpiry = document.getElementById('customExpiry');
            const uploadStatus = document.getElementById('uploadStatus');

            // QR Modal
            const qrModal = document.getElementById('qrModal');
            const qrImageContainer = document.getElementById('qrImageContainer');
            const qrFileName = document.getElementById('qrFileName');
            const closeQrModal = document.getElementById('closeQrModal');

            // QR Scanner
            const scanQrBtn = document.getElementById('scanQrBtn');
            const scannerContainer = document.getElementById('qr-scanner-container');
            const closeScanner = document.getElementById('closeScanner');
            const readerElement = document.getElementById('reader');
            let html5QrCode = null;

            // ========== UTILS ==========
            function formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(1024));
                return parseFloat((bytes / Math.pow(1024, i)).toFixed(1)) + ' ' + sizes[i];
            }

            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // ========== GENERATE QR CODE (via API) ==========
            function showQrModal(fileId, fileName) {
                const url = new URL(window.location.href);
                url.hash = `#file-${fileId}`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url.toString())}`;
                qrImageContainer.innerHTML = `<img src="${qrUrl}" alt="QR Code">`;
                qrFileName.textContent = `üìÑ ${fileName}`;
                qrModal.style.display = 'flex';
            }

            // ========== SCAN QR ==========
            function startScanner() {
                scannerContainer.style.display = 'flex';
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start(
                    { facingMode: "environment" }, // kamera belakang
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    (decodedText) => {
                        // Sukses scan
                        html5QrCode.stop().then(() => {
                            scannerContainer.style.display = 'none';
                            // Proses URL
                            try {
                                const url = new URL(decodedText);
                                if (url.hash && url.hash.startsWith('#file-')) {
                                    window.location.href = decodedText; // redirect otomatis download
                                } else {
                                    alert('QR Code bukan link file yang valid.');
                                }
                            } catch (e) {
                                alert('QR Code tidak valid.');
                            }
                        }).catch(err => console.error(err));
                    },
                    (errorMessage) => {
                        // ignore, terus scan
                    }
                ).catch(err => {
                    alert('Gagal akses kamera: ' + err);
                    scannerContainer.style.display = 'none';
                });
            }

            // ========== RENDER FILE LIST ==========
            async function renderFileList() {
                const files = await getAllFiles();
                const now = Date.now();

                // Filter expired
                const validFiles = files.filter(f => f.expiresAt > now);
                // Hapus yang expired dari DB
                for (let f of files) {
                    if (f.expiresAt <= now) {
                        await deleteFile(f.id);
                    }
                }

                const totalBytes = validFiles.reduce((acc, f) => acc + (f.size || 0), 0);
                totalSizeSpan.textContent = formatBytes(totalBytes);

                if (validFiles.length === 0) {
                    fileListContainer.innerHTML = `<div class="empty-message">üì≠ Tidak ada file. Upload sekarang!</div>`;
                    return;
                }

                // Urutkan dari yang terbaru
                validFiles.sort((a,b) => b.uploadedAt - a.uploadedAt);

                let html = '';
                validFiles.forEach(file => {
                    const expiresInMs = file.expiresAt - now;
                    const expiresInSec = Math.floor(expiresInMs / 1000);
                    const minutes = Math.floor(expiresInSec / 60);
                    const seconds = expiresInSec % 60;
                    let timeText = '';
                    if (expiresInSec <= 0) timeText = '‚èπÔ∏è Expired';
                    else if (minutes > 0) timeText = `‚è≥ ${minutes} menit ${seconds} detik`;
                    else timeText = `‚è≥ ${seconds} detik`;

                    const expiredClass = expiresInSec <= 0 ? 'expired' : '';

                    html += `
                        <div class="file-item" data-file-id="${escapeHtml(file.id)}">
                            <div class="file-info">
                                <div class="file-name">üìÑ ${escapeHtml(file.name)}</div>
                                <div class="file-meta">
                                    <span>${formatBytes(file.size)}</span>
                                    <span class="countdown ${expiredClass}">${timeText}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn-sm" onclick="window.copyLink('${escapeHtml(file.id)}')">üîó Copy Link</button>
                                <button class="btn-sm" onclick="window.showQR('${escapeHtml(file.id)}', '${escapeHtml(file.name)}')">üì∑ QR</button>
                                <button class="btn-sm btn-delete" onclick="window.deleteFileById('${escapeHtml(file.id)}')">‚úï Hapus</button>
                            </div>
                        </div>
                    `;
                });
                fileListContainer.innerHTML = html;
            }

            // ========== WINDOW FUNCTIONS (dipanggil dari HTML) ==========
            window.copyLink = function(fileId) {
                const url = new URL(window.location.href);
                url.hash = `#file-${fileId}`;
                navigator.clipboard.writeText(url.toString()).then(() => {
                    uploadStatus.innerText = '‚úÖ Link disalin ke clipboard!';
                    setTimeout(() => { uploadStatus.innerText = ''; }, 3000);
                }).catch(() => {
                    prompt('‚ùå Gagal menyalin otomatis. Salin manual:', url.toString());
                });
            };

            window.deleteFileById = async function(fileId) {
                await deleteFile(fileId);
                renderFileList();
                uploadStatus.innerText = 'üóëÔ∏è File dihapus';
                setTimeout(() => { uploadStatus.innerText = ''; }, 2000);
            };

            window.showQR = function(fileId, fileName) {
                showQrModal(fileId, fileName);
            };

            // ========== UPLOAD HANDLER ==========
            async function handleUpload(files) {
                if (!files || files.length === 0) return;

                let expirySeconds = parseInt(expirySelect.value);
                if (expirySelect.value === '0') {
                    expirySeconds = parseInt(customExpiry.value);
                    if (isNaN(expirySeconds) || expirySeconds <= 0) {
                        alert('Masukkan durasi expired dalam detik (minimal 1)');
                        return;
                    }
                }

                for (let i = 0; i < files.length; i++) {
                    await saveFile(files[i], expirySeconds);
                }
                await renderFileList();
                uploadStatus.innerText = `‚úÖ ${files.length} file diupload, expired dalam ${expirySeconds} detik.`;
                setTimeout(() => { uploadStatus.innerText = ''; }, 4000);
                fileInput.value = '';
            }

            // ========== EVENT LISTENER ==========
            fileInput.addEventListener('change', (e) => handleUpload(e.target.files));

            // Drag & drop
            document.body.addEventListener('dragover', (e) => e.preventDefault());
            document.body.addEventListener('drop', async (e) => {
                e.preventDefault();
                if (e.dataTransfer.files.length > 0) {
                    await handleUpload(e.dataTransfer.files);
                }
            });

            // Toggle custom expiry
            expirySelect.addEventListener('change', function() {
                customExpiry.style.display = this.value === '0' ? 'inline-block' : 'none';
            });

            // QR Modal close
            closeQrModal.addEventListener('click', () => {
                qrModal.style.display = 'none';
            });

            // Scan QR button
            scanQrBtn.addEventListener('click', () => {
                startScanner();
            });

            // Close scanner
            closeScanner.addEventListener('click', () => {
                if (html5QrCode) {
                    html5QrCode.stop().catch(err => console.error(err));
                }
                scannerContainer.style.display = 'none';
            });

            // Click outside modal to close
            window.addEventListener('click', (e) => {
                if (e.target === qrModal) {
                    qrModal.style.display = 'none';
                }
                if (e.target === scannerContainer) {
                    if (html5QrCode) html5QrCode.stop().catch(err => console.error(err));
                    scannerContainer.style.display = 'none';
                }
            });

            // ========== HANDLE LINK DOWNLOAD (hash) ==========
            async function handleHash() {
                const hash = window.location.hash;
                if (hash && hash.startsWith('#file-')) {
                    const fileId = hash.substring(6);
                    const fileData = await getFile(fileId);
                    if (!fileData) {
                        alert('‚ùå File tidak ditemukan atau sudah expired.');
                        window.location.hash = '';
                        return;
                    }
                    if (fileData.expiresAt <= Date.now()) {
                        alert('‚èπÔ∏è File sudah expired.');
                        await deleteFile(fileId);
                        window.location.hash = '';
                        return;
                    }
                    // Download file
                    const blob = fileData.blob;
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileData.name;
                    a.click();
                    URL.revokeObjectURL(url);
                    window.location.hash = '';
                }
            }

            // ========== INIT ==========
            window.onload = async function() {
                await openDB();
                await renderFileList();
                await handleHash();
                refreshInterval = setInterval(renderFileList, 1000);
            };

            window.onbeforeunload = function() {
                if (refreshInterval) clearInterval(refreshInterval);
                if (html5QrCode) html5QrCode.stop().catch(err => console.error(err));
            };

            window.addEventListener('hashchange', handleHash);
        })();
    </script>
</body>
</html>
